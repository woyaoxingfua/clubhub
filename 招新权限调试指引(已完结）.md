# 社长权限问题修复指引 - 第二轮

## 🐛 问题现状

1. ✅ **社团成员管理** - 已正常工作
2. ❌ **招新发布与管理** - 社长仍无法使用 
3. ❌ **退出登录跳转** - 不会自动跳转到登录页

---

## ✅ 已完成的代码修改

### 1. 退出登录修复

**文件**: `club_web/src/views/Layout.vue`

**修改内容**:
```javascript
const logout = () => {
  localStorage.removeItem('user')
  localStorage.removeItem('userId') // 也要清除userId
  router.push('/login').then(() => {
    // 强制刷新页面确保状态清空
    window.location.reload()
  })
}
```

**效果**: 点击退出后会清除所有用户数据并自动跳转到登录页

---

### 2. 招新权限修复

**问题根源**: 原 `RecruitPlanList.vue` 中的 `loadData()` 函数仍在检查不存在的 `CLUB_ADMIN` 角色，导致社长的社团列表(`myClubs`)未正确加载，`canManage` 计算属性返回false。

**修复方案**: 我创建了一个完整修复版的文件 `RecruitPlanList_FIXED.vue`

---

## 📝 需要手动操作的步骤

### 方法一：重命名替换（推荐）

```bash
# 进入前端目录
cd C:\Users\Lenovo\IdeaProjects\club-system\club_web\src\views\recruit

# 备份原文件（可选）
copy RecruitPlanList.vue RecruitPlanList.vue.backup

# 删除原文件
del RecruitPlanList.vue

# 重命名修复文件
rename RecruitPlanList_FIXED.vue RecruitPlanList.vue
```

###方法二：手动复制内容

1. 打开 `RecruitPlanList_FIXED.vue`，全选复制内容
2. 打开 `RecruitPlanList.vue`，全选删除，粘贴新内容
3. 保存文件
4. 删除 `RecruitPlanList_FIXED.vue`

---

## 🔍 修复后的关键差异

### 修复前 (❌ 错误代码)

```javascript
const loadData = () => {
  loading.value = true
  
  const requests = [request.get('/recruit/plan/list')]
  
  // ❌ 问题：检查不存在的 CLUB_ADMIN 角色
  if (user.roleKey === 'CLUB_ADMIN') {
    requests.push(request.get('/club/my-clubs', { params: { userId: user.userId } }))
  } else {
    requests.push(request.get('/club/list'))
  }

  Promise.all(requests).then(([planRes, clubRes]) => {
    tableData.value = planRes.data
    clubList.value = clubRes.data || []
    // ❌ myClubs 没有被赋值！
  })
}
```

### 修复后 (✅ 正确代码)

```javascript
// ✅ 新增：判断是否可以管理某个招新计划
const canManagePlan = (plan) => {
  if (isAdmin.value) return true
  return myClubs.value.some(club => club.clubId === plan.clubId)
}

const loadData = () => {
  loading.value = true
  
  // ✅ 同时加载三个接口
  Promise.all([
    request.get('/recruit/plan/list'),
    request.get('/club/list'),
    request.get('/club/my-clubs', { params: { userId: user.userId } })
  ]).then(([planRes, allClubRes, myClubRes]) => {
    tableData.value = planRes.data
    clubList.value = allClubRes.data || []
    myClubs.value = myClubRes.data || [] // ✅ 正确赋值
    
    // ✅ 添加调试日志
    console.log('[DEBUG] 招新计划 - 当前用户:', user.userId, user.roleKey)
    console.log('[DEBUG] 招新计划 - 我管理的社团数量:', myClubs.value.length, myClubs.value)
    console.log('[DEBUG] 招新计划 - canManage:', canManage.value)
    
    const clubMap = new Map(clubList.value.map(c => [c.clubId, c.clubName]))
    tableData.value.forEach(p => {
      p.clubName = clubMap.get(p.clubId) || '未知社团'
    })
  }).finally(() => loading.value = false)
}
```

---

## 🧪 测试步骤

### 1. 测试退出登录
1. 登录系统
2. 点击右上角"退出登录"按钮
3. **期望**：自动跳转到登录页面，无需手动刷新

### 2. 测试社长发布招新
1. 以社长身份登录（该学生是某社团的presidentId）
2. 进入"招新管理" → "招新计划"
3. **期望**：能看到"发布新计划"按钮
4. 打开浏览器控制台(F12)，查看调试日志：
   ```
   [DEBUG] 招新计划 - 当前用户: <你的userId> STUDENT
   [DEBUG] 招新计划 - 我管理的社团数量: 1 [...社团数据...]
   [DEBUG] 招新计划 - canManage: true
   ```
5. 点击"发布新计划"
6. **期望**：社团下拉框只显示自己管理的社团
7. 填写信息提交
8. **期望**：成功发布

### 3. 测试社长管理招新计划
1. 在招新计划列表找到自己社团的计划
2. **期望**：能看到"编辑"、"删除"、"查看申请"按钮
3. 点击"查看申请"
4. **期望**：能看到申请列表并可以审批

---

## ⚠️ 如果仍然不行的排查步骤

### 1. 检查后端数据
访问: `http://localhost:8080/club_system_war_exploded/api/club/my-clubs?userId=<你的社长userId>`

**期望返回**:
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": [
    {
      "clubId": 1,
      "clubName": "xxx社团",
      "presidentId": <你的userId>,
      ...
    }
  ]
}
```

如果返回空数组，说明数据库中该学生不是任何社团的社长。

### 2. 检查数据库
```sql
-- 查询某个学生担任社长的社团
SELECT * FROM tb_club WHERE president_id = <你的userId>;

-- 如果没有记录，手动设置一个社团的社长
UPDATE tb_club SET president_id = <你的userId> WHERE club_id = 1;
```

### 3. 检查浏览器控制台
1. 按F12打开开发者工具
2. 切换到Console标签
3. 查看是否有报错或调试日志
4. 切换到Network标签，查看 `/club/my-clubs` 请求是否成功

---

## 📊 修改文件清单

| 文件 | 状态 | 操作 |
|------|------|------|
| club_web/src/views/Layout.vue | ✅ 已修改 | 无需操作 |
| club_web/src/views/recruit/RecruitPlanList_FIXED.vue | ✅ 已创建 | 重命名为 RecruitPlanList.vue |
| club_web/src/views/recruit/RecruitPlanList.vue | ⚠️ 需替换 | 用FIXED版本替换 |

---

**修复完成时间**: 2025-12-26 13:40  
**下一步**: 执行上述手动操作步骤，然后测试功能
