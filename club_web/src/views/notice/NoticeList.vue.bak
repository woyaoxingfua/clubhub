<template>
  <div class="club-list-container">
    <div class="toolbar">
      <h2>ğŸ° ç¤¾å›¢ä¿¡æ¯ç®¡ç†</h2>
      <el-button v-if="isAdmin" type="primary" @click="openDialog()">
        <el-icon style="margin-right: 5px"><Plus /></el-icon> åˆ›å»ºæ–°ç¤¾å›¢
      </el-button>
    </div>

    <el-table :data="tableData" border stripe v-loading="loading">
      <el-table-column prop="clubId" label="ID" width="60" align="center" />
      <el-table-column prop="clubName" label="ç¤¾å›¢åç§°" width="150" font-weight="bold" />
      <el-table-column prop="category" label="åˆ†ç±»" width="100">
        <template #default="scope">
          <el-tag>{{ scope.row.category || 'ç»¼åˆç±»' }}</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="deptName" label="æ‰€å±é™¢ç³»" width="140" />
      <el-table-column prop="presidentName" label="ç¤¾é•¿" width="100" />
      <el-table-column prop="advisorName" label="æŒ‡å¯¼è€å¸ˆ" width="100" />
      <el-table-column prop="description" label="ç¤¾å›¢ç®€ä»‹" show-overflow-tooltip />
      
      <el-table-column label="æ“ä½œ" width="220" align="center" fixed="right">
        <template #default="scope">
          
          <template v-if="canManage(scope.row)">
            <el-button size="small" type="primary" link @click="openDialog(scope.row)">ç¼–è¾‘</el-button>
            <el-button size="small" type="warning" link @click="openMemberDrawer(scope.row)">æˆå‘˜ç®¡ç†</el-button>
            <el-popconfirm v-if="isAdmin" title="ç¡®å®šè§£æ•£ç¤¾å›¢ï¼Ÿ" @confirm="handleDelete(scope.row.clubId)">
              <template #reference>
                <el-button size="small" type="danger" link>åˆ é™¤</el-button>
              </template>
            </el-popconfirm>
          </template>

          <template v-else>
            <el-popconfirm title="ç¡®å®šè¦åŠ å…¥è¿™ä¸ªç¤¾å›¢å—ï¼Ÿ" @confirm="handleJoin(scope.row.clubId)">
              <template #reference>
                <el-button size="small" type="success" plain>ç”³è¯·åŠ å…¥</el-button>
              </template>
            </el-popconfirm>
          </template>

        </template>
      </el-table-column>
    </el-table>

    <el-dialog v-model="dialogVisible" :title="form.clubId ? 'ç¼–è¾‘ç¤¾å›¢' : 'åˆ›å»ºç¤¾å›¢'" width="500px">
      <el-form :model="form" label-width="80px">
        <el-form-item label="ç¤¾å›¢åç§°">
          <el-input v-model="form.clubName" :disabled="!isAdmin && !!form.clubId" />
        </el-form-item>
        <el-form-item label="ç¤¾å›¢åˆ†ç±»">
          <el-select v-model="form.category" placeholder="è¯·é€‰æ‹©">
            <el-option label="ç§‘æŠ€ç±»" value="ç§‘æŠ€ç±»" />
            <el-option label="è‰ºæœ¯ç±»" value="è‰ºæœ¯ç±»" />
            <el-option label="ä½“è‚²ç±»" value="ä½“è‚²ç±»" />
            <el-option label="å…¬ç›Šç±»" value="å…¬ç›Šç±»" />
          </el-select>
        </el-form-item>
        <el-form-item label="æ‰€å±é™¢ç³»">
          <el-select v-model="form.deptId" placeholder="è¯·é€‰æ‹©(ä¸é€‰é»˜è®¤ä¸ºæ ¡çº§)" clearable :disabled="!isAdmin">
            <el-option v-for="d in deptList" :key="d.deptId" :label="d.deptName" :value="d.deptId" />
          </el-select>
        </el-form-item>
        <el-form-item label="ç¤¾é•¿">
          <el-select v-model="form.presidentId" placeholder="è¯·é€‰æ‹©ç¤¾é•¿" filterable :disabled="!isAdmin">
            <el-option v-for="u in userList" :key="u.userId" :label="u.realName" :value="u.userId" />
          </el-select>
        </el-form-item>
        <el-form-item label="æŒ‡å¯¼è€å¸ˆ">
          <el-select v-model="form.advisorId" placeholder="è¯·é€‰æ‹©æŒ‡å¯¼è€å¸ˆ" filterable :disabled="!isAdmin">
            <el-option v-for="u in teacherList" :key="u.userId" :label="u.realName" :value="u.userId" />
          </el-select>
        </el-form-item>
        <el-form-item label="ç¤¾å›¢ç®€ä»‹">
          <el-input v-model="form.description" type="textarea" />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="submitForm">ç¡®å®š</el-button>
      </template>
    </el-dialog>

    <el-drawer v-model="drawerVisible" title="ç¤¾å›¢æˆå‘˜åˆ—è¡¨" size="40%">
      <div style="margin-bottom: 20px; font-weight: bold; font-size: 16px;">
        å½“å‰ç¤¾å›¢ï¼š{{ currentClubName }}
      </div>
      
      <el-table :data="memberList" stripe border height="500px">
        <el-table-column prop="studentName" label="å­¦ç”Ÿå§“å" width="120" />
        
        <el-table-column prop="position" label="ç¤¾å†…èŒä½" width="100">
          <template #default="scope">
            <el-tag size="small" type="info">{{ scope.row.position }}</el-tag>
          </template>
        </el-table-column>

        <el-table-column prop="joinTime" label="åŠ å…¥æ—¶é—´" />
        
        <el-table-column label="æ“ä½œ" width="80" align="center">
          <template #default="scope">
            <el-popconfirm title="ç¡®å®šç§»é™¤è¯¥æˆå‘˜ï¼Ÿ" @confirm="handleKick(scope.row.id)">
              <template #reference>
                <el-button type="danger" size="small" icon="Delete" circle />
              </template>
            </el-popconfirm>
          </template>
        </el-table-column>
      </el-table>
    </el-drawer>

  </div>
</template>

<script setup>
import { ref, onMounted, reactive, computed } from 'vue'
import request from '@/utils/request'
import { ElMessage } from 'element-plus'
import { Plus, Delete } from '@element-plus/icons-vue'

const loading = ref(false)
const tableData = ref([])
const userList = ref([]) // æ‰€æœ‰ç”¨æˆ·
const deptList = ref([]) // æ‰€æœ‰é™¢ç³»
const dialogVisible = ref(false)
const user = JSON.parse(localStorage.getItem('user') || '{}')

// æˆå‘˜ç®¡ç†ç›¸å…³å˜é‡
const drawerVisible = ref(false)
const memberList = ref([])
const currentClubName = ref('')
const currentClubId = ref(null)

const isAdmin = computed(() => {
  return user.roleKey === 'SYS_ADMIN' || user.roleKey === 'DEPT_ADMIN'
})

// åˆ¤æ–­æ˜¯å¦æœ‰ç®¡ç†æƒé™ï¼ˆç®¡ç†å‘˜ OR æœ¬ç¤¾ç¤¾é•¿ï¼‰
const canManage = (clubRow) => {
  if (isAdmin.value) return true
  // åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯è¯¥ç¤¾å›¢çš„ç¤¾é•¿
  // ä½¿ç”¨ == å…è®¸ç±»å‹è½¬æ¢ (string vs number)
  return clubRow.presidentId == user.userId
}

// è¿‡æ»¤å‡ºè€å¸ˆåˆ—è¡¨ï¼ˆç”¨äºæŒ‡å¯¼è€å¸ˆé€‰æ‹©ï¼‰
const teacherList = computed(() => {
  return userList.value.filter(u => u.roleKey === 'TEACHER' || u.roleKey === 'SYS_ADMIN')
})

const form = reactive({
  clubId: null,
  clubName: '',
  category: '',
  presidentId: null, // æ”¹ä¸º ID
  advisorId: null,   // æ”¹ä¸º ID
  deptId: null,      // æ–°å¢ deptId
  description: ''
})

const loadData = () => {
  loading.value = true
  Promise.all([
    request.get('/club/list'),
    request.get('/auth/list'), // è·å–ç”¨æˆ·åˆ—è¡¨
    request.get('/dept/list')  // è·å–é™¢ç³»åˆ—è¡¨
  ]).then(([clubRes, userRes, deptRes]) => {
    userList.value = userRes.data
    deptList.value = deptRes.data
    const userMap = new Map(userList.value.map(u => [u.userId, u.realName]))
    const deptMap = new Map(deptList.value.map(d => [d.deptId, d.deptName]))

    // å¡«å……åå­—
    tableData.value = clubRes.data.map(club => {
      club.presidentName = userMap.get(club.presidentId) || 'æœªçŸ¥'
      club.advisorName = userMap.get(club.advisorId) || 'æœªçŸ¥'
      club.deptName = deptMap.get(club.deptId) || 'æ ¡çº§/æœªåˆ†é…'
      return club
    })
  }).finally(() => {
    loading.value = false
  })
}

const openDialog = (row = null) => {
  if (row) {
    // èµ‹å€¼æ—¶æ³¨æ„å­—æ®µå¯¹åº”
    Object.assign(form, row)
  } else {
    form.clubId = null
    form.clubName = ''
    form.category = ''
    form.presidentId = null
    form.advisorId = null
    form.deptId = null
    form.description = ''
  }
  dialogVisible.value = true
}

const submitForm = () => {
  if (!form.clubName) {
    ElMessage.warning('ç¤¾å›¢åç§°ä¸èƒ½ä¸ºç©º')
    return
  }
  const url = form.clubId ? '/club/update' : '/club/add'
  const method = form.clubId ? 'put' : 'post'
  request[method](url, form).then(res => {
    ElMessage.success(res.msg)
    dialogVisible.value = false
    loadData()
  })
}

const handleDelete = (id) => {
  request.delete(`/club/${id}`).then(res => {
    ElMessage.success('æ“ä½œæˆåŠŸ')
    loadData()
  })
}

// --- æ–°å¢ï¼šå­¦ç”ŸåŠ å…¥ç¤¾å›¢ ---
const handleJoin = (clubId) => {
  request.post('/member/join', {
    clubId: clubId,
    userId: user.userId
  }).then(res => {
    ElMessage.success(res.msg)
  })
}

// --- æ–°å¢ï¼šæ‰“å¼€æˆå‘˜ç®¡ç†æŠ½å±‰ ---
const openMemberDrawer = (row) => {
  currentClubName.value = row.clubName
  currentClubId.value = row.clubId
  drawerVisible.value = true
  loadMembers(row.clubId)
}

// åŠ è½½æˆå‘˜åˆ—è¡¨
const loadMembers = (clubId) => {
  request.get(`/member/list/${clubId}`).then(res => {
    memberList.value = res.data
  })
}

// è¸¢äºº
const handleKick = (memberId) => {
  request.delete(`/member/${memberId}`).then(res => {
    ElMessage.success('å·²ç§»å‡ºè¯¥æˆå‘˜')
    loadMembers(currentClubId.value) // åˆ·æ–°åˆ—è¡¨
  })
}

onMounted(() => {
  loadData()
})
</script>

<style scoped>
.club-list-container {
  padding: 20px;
  background: white;
  border-radius: 8px;
}
.toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}
</style>